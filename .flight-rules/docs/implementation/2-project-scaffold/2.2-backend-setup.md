# 2.2 Backend Setup

## Overview

Define the Convex backend structure of a generated project. The Convex CLI provides the base setup; r9stack adds schema patterns and function examples.

## What Comes From Convex CLI

**Convex CLI provides:**
- `convex/` directory structure
- `convex/_generated/` with TypeScript types
- Basic configuration files
- Development server setup

## What r9stack Adds

- User schema with WorkOS integration fields
- Example domain table (for reference patterns)
- Query and mutation patterns with auth
- Convex client setup in React

---

## 2.2.1 Convex CLI Output (Reference)

**Goal:** Document what the Convex CLI produces so we know the base state.

**Expected structure after `npx convex init` + `npx convex dev`:**
```
convex/
â”œâ”€â”€ _generated/          # Auto-generated types
â”‚   â”œâ”€â”€ api.d.ts
â”‚   â”œâ”€â”€ dataModel.d.ts
â”‚   â””â”€â”€ server.d.ts
â”œâ”€â”€ schema.ts            # Database schema (empty/example)
â””â”€â”€ functions/           # Or files at root level
```

**Status:** ðŸ”µ Planned

---

## 2.2.2 User Schema (r9stack adds)

**Goal:** Define the users table for WorkOS integration.

**Schema definition (V1):**
```typescript
// convex/schema.ts
export default defineSchema({
  users: defineTable({
    // WorkOS identity
    workosUserId: v.string(),
    email: v.string(),
    name: v.optional(v.string()),
    avatarUrl: v.optional(v.string()),
    
    // Timestamps
    createdAt: v.number(),
    updatedAt: v.number(),
  })
    .index("by_workos_id", ["workosUserId"])
    .index("by_email", ["email"]),
});
```

> **Post-V1:** Stripe integration will add `stripeCustomerId`, `subscriptionStatus`, `subscriptionTier` fields and related indexes.

**Status:** ðŸ”µ Planned

---

## 2.2.3 Query Patterns (r9stack adds)

**Goal:** Provide example authenticated query patterns.

**Files to create:**
```
convex/
â”œâ”€â”€ users.ts             # User queries and mutations
â””â”€â”€ example.ts           # Example domain queries (optional)
```

**Example patterns to demonstrate:**
- Get current user from auth context
- Query with authentication required
- Query with optional authentication

**Status:** ðŸ”µ Planned

---

## 2.2.4 Mutation Patterns (r9stack adds)

**Goal:** Provide example authenticated mutation patterns.

**Example patterns to demonstrate:**
- Create/update with auth context
- Input validation with Convex validators
- Optimistic update patterns (client-side)

**Status:** ðŸ”µ Planned

---

## 2.2.5 Convex Client Setup (r9stack adds)

**Goal:** Configure Convex client with auth integration in the React app.

**Files to create/modify:**
```
lib/
â””â”€â”€ convex.ts            # Convex client configuration
app/
â””â”€â”€ routes/
    â””â”€â”€ __root.tsx       # Add ConvexProvider with auth
```

**Steps:**
- Create Convex client with auth token provider
- Wrap app in ConvexProvider
- Configure for WorkOS JWT tokens

**Status:** ðŸ”µ Planned
