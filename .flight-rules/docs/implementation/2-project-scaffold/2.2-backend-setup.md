# 2.2 Backend Setup

## Overview

Define the Convex backend structure of a generated project. The Convex CLI (via TanStack Start add-on) provides the base setup; r9stack adds schema patterns and function examples via payload templates.

> **Dependency Note:** This spec assumes the `--add-ons convex` flag provides the base `convex/` directory structure. The gap analysis task (1.3.1b) will validate what the add-on creates. r9stack payload templates add the files marked "(r9stack)" below.

## What Comes From Convex Add-on

**Convex add-on provides (assumed):**
- `convex/` directory structure
- `convex/_generated/` with TypeScript types
- Basic configuration files
- Development server setup

## What r9stack Adds (Payload Templates)

r9stack adds backend files via the payload directory (`payload/convex/`):

- User schema with WorkOS integration fields
- Example queries/mutations demonstrating auth patterns
- Demo messages table for real-time example
- ConvexClientProvider component (in `payload/components/`)

---

## 2.2.1 Convex Add-on Output (Reference)

**Goal:** Document what the Convex add-on produces so we know the base state.

> **Dependency:** Gap analysis (1.3.1b) will document the actual add-on output. Structure below is expected based on Convex CLI behavior.

**Expected structure from `--add-ons convex`:**
```
convex/
â”œâ”€â”€ _generated/          # Auto-generated types (created on first `npx convex dev`)
â”‚   â”œâ”€â”€ api.d.ts
â”‚   â”œâ”€â”€ api.js
â”‚   â”œâ”€â”€ dataModel.d.ts
â”‚   â”œâ”€â”€ server.d.ts
â”‚   â””â”€â”€ server.js
â”œâ”€â”€ schema.ts            # Database schema (may be empty/example)
â”œâ”€â”€ tsconfig.json        # Convex TypeScript config
â””â”€â”€ README.md            # Convex getting started
```

**Status:** ðŸ”µ Planned (pending gap analysis)

---

## 2.2.2 User Schema (Payload Template)

**Goal:** Define the users table for WorkOS integration.

**Payload file:** `payload/convex/schema.ts`

**Schema definition (V1):**
```typescript
// convex/schema.ts
import { defineSchema, defineTable } from 'convex/server'
import { v } from 'convex/values'

export default defineSchema({
  users: defineTable({
    // WorkOS identity
    workosUserId: v.string(),
    email: v.string(),
    name: v.optional(v.string()),
    avatarUrl: v.optional(v.string()),
    
    // Timestamps
    createdAt: v.number(),
    updatedAt: v.number(),
  })
    .index("by_workos_id", ["workosUserId"])
    .index("by_email", ["email"]),

  // Demo table for real-time example
  messages: defineTable({
    text: v.string(),
    userId: v.optional(v.id("users")),
    createdAt: v.number(),
  }),
});
```

> **Post-V1:** Stripe integration will add `stripeCustomerId`, `subscriptionStatus`, `subscriptionTier` fields and related indexes.

**Status:** ðŸ”µ Planned

---

## 2.2.3 Query and Mutation Patterns (Payload Templates)

**Goal:** Provide working example queries and mutations that demonstrate auth and real-time patterns.

**Payload files:**
```
payload/convex/
â”œâ”€â”€ messages.ts          # Demo CRUD for messages table
â””â”€â”€ auth.config.ts       # Auth configuration (if not from add-on)
```

**Example patterns demonstrated in `messages.ts`:**

```typescript
// convex/messages.ts
import { query, mutation } from './_generated/server'
import { v } from 'convex/values'

// Query: List all messages (real-time)
export const list = query({
  args: {},
  handler: async (ctx) => {
    return await ctx.db.query('messages').order('desc').take(50)
  },
})

// Mutation: Send a message
export const send = mutation({
  args: { text: v.string() },
  handler: async (ctx, args) => {
    await ctx.db.insert('messages', {
      text: args.text,
      createdAt: Date.now(),
    })
  },
})
```

**Patterns demonstrated:**
- Real-time query with ordering
- Mutation with input validation
- Timestamp handling

**Status:** ðŸ”µ Planned

---

## 2.2.4 Convex Client Setup (Payload Template)

**Goal:** Configure SSR-safe Convex client in the React app.

**Payload file:** `payload/components/ConvexClientProvider.tsx`

**Implementation (validated in sandbox):**

```typescript
// src/components/ConvexClientProvider.tsx
import { ConvexProvider, ConvexReactClient } from 'convex/react'
import { ReactNode, useEffect, useState } from 'react'

export function ConvexClientProvider({ children }: { children: ReactNode }) {
  const [client, setClient] = useState<ConvexReactClient | null>(null)

  useEffect(() => {
    const convexUrl = import.meta.env.VITE_CONVEX_URL as string
    if (convexUrl) {
      setClient(new ConvexReactClient(convexUrl))
    }
  }, [])

  if (!client) {
    return <>{children}</>  // Render children without Convex during SSR
  }

  return <ConvexProvider client={client}>{children}</ConvexProvider>
}
```

**Key pattern:** Client is created in `useEffect` to avoid SSR hydration errors (see Critical Learnings).

**Integration:** Added to `__root.tsx` provider hierarchy (see 2.1.5).

**Status:** âœ… Complete (pattern validated in sandbox)
