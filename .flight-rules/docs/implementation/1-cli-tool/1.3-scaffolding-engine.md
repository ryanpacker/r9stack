# 1.3 Scaffolding Engine

## Overview

The core engine that orchestrates project creation. This follows a **command-first approach**: leverage TanStack Start's add-on system to scaffold as much as possible with a single command, then apply minimal templates only for gaps that add-ons don't cover.

## Task Group Goals

- Execute TanStack Start CLI with appropriate add-ons
- Identify gaps between add-on output and target structure
- Apply integration templates only where needed
- Install additional dependencies (iron-session)
- Provide progress feedback throughout the process

## Initialization Order (V1)

```
1. TanStack Start with add-ons  â†’  Base React project with integrations
2. Gap analysis (future)        â†’  Compare output to target
3. r9stack templates            â†’  App shell, protected routes, integration glue
4. Additional dependencies      â†’  iron-session
5. Post-scaffold config         â†’  .env.example, setup instructions
```

> **Note:** Stripe payment integration is deferred to post-V1.

---

## 1.3.1 CLI Orchestration

**Goal:** Execute TanStack Start CLI with add-ons, then supplement with templates.

### Primary Command

```bash
npm create @tanstack/start@latest <project-name> -- \
  --framework React \
  --package-manager npm \
  --toolchain eslint \
  --tailwind \
  --add-ons shadcn,convex,workos
```

### TanStack Start CLI Flags (Validated)

| Flag | Value | Purpose |
|------|-------|---------|
| `--framework` | `React` | Framework choice |
| `--package-manager` | `npm\|yarn\|pnpm\|bun` | User preference |
| `--toolchain` | `eslint` | Linting/formatting |
| `--tailwind` | (flag) | Add Tailwind CSS |
| `--add-ons` | `shadcn,convex,workos` | Built-in integrations |
| `--target-dir` | `<path>` | Output directory |
| `--no-git` | (flag) | Skip git init if needed |

### Built-in Add-ons Available

shadcn, convex, workos, clerk, neon, sentry, prisma, drizzle, trpc, tanstack-query, storybook, and more.

### Gap Analysis (Future Task)

Before finalizing templates, compare add-on output against the validated target (`tmp/r9teststack`):

1. Run TanStack Start with all add-ons
2. Compare file structure to blueprint
3. Identify what add-ons provide vs what's missing
4. Create templates only for gaps

**Status:** ðŸŸ¡ In Progress (CLI command validated, gap analysis pending)

---

## 1.3.2 Integration Templates

**Goal:** Apply minimal template files for integration code that add-ons don't provide.

### Likely Templates Needed (pending gap analysis)

Based on the validated target, these are likely gaps:

| Template | Purpose |
|----------|---------|
| App Shell | AppShell.tsx, Sidebar.tsx, NavGroup.tsx, NavItem.tsx |
| User Menu | UserMenu.tsx with auth-aware dropdown |
| Protected Routes | `/app/route.tsx` with auth guard |
| Auth Helpers | Additional iron-session integration if needed |
| Demo Pages | Example pages showing Convex usage |

### Template Application Steps

1. Copy template files to appropriate locations
2. Handle variable substitution (project name in titles, etc.)
3. Merge with existing files where needed (e.g., updating root layout)

**Status:** ðŸ”µ Planned (after gap analysis)

---

## 1.3.3 Additional Dependencies

**Goal:** Install dependencies that add-ons don't include.

### Dependencies to Add

```bash
npm install iron-session
```

iron-session is required for encrypted cookie sessions with WorkOS. The WorkOS add-on may not include this.

**Status:** ðŸ”µ Planned

---

## 1.3.4 Post-Scaffold Configuration

**Goal:** Create configuration files and finalize setup.

### Files to Create/Update

| File | Purpose |
|------|---------|
| `.env.example` | Template for environment variables |
| `components.json` | Ensure shadcn config matches target |

### Environment Variables Template

```bash
# Convex (auto-populated by `npx convex dev`)
VITE_CONVEX_URL=

# WorkOS (get from https://dashboard.workos.com)
WORKOS_API_KEY=
WORKOS_CLIENT_ID=
WORKOS_REDIRECT_URI=http://localhost:3000/auth/callback

# Session (generate with: openssl rand -base64 32)
WORKOS_COOKIE_PASSWORD=
```

**Status:** ðŸ”µ Planned

---

## 1.3.5 Progress Feedback

**Goal:** Keep users informed during the scaffolding process.

### UX Requirements

- Show clear step indicators (Step 1/4: Creating project...)
- Stream output from TanStack CLI
- Use spinners for longer operations
- Provide clear success/error states
- Show summary and next steps on completion

### Post-Scaffold Instructions

```
âœ… Project created!

Next steps:

1. Set up WorkOS:
   â†’ Create account: https://workos.com/
   â†’ Create application
   â†’ Set redirect URI: http://localhost:3000/auth/callback
   â†’ Copy credentials to .env.local

2. Set up Convex:
   â†’ Run: npx convex dev
   â†’ Follow prompts to create account/project

3. Generate session secret:
   â†’ Run: openssl rand -base64 32
   â†’ Add to .env.local as WORKOS_COOKIE_PASSWORD

4. Start development:
   â†’ Run: npm run dev
   â†’ Open: http://localhost:3000
```

**Status:** ðŸ”µ Planned
