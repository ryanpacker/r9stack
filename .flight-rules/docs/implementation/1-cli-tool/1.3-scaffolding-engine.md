# 1.3 Scaffolding Engine

## Overview

The core engine that orchestrates project creation. This follows a **command-first approach**: leverage TanStack Start's add-on system to scaffold as much as possible with a single command, then apply minimal templates only for gaps that add-ons don't cover.

## Task Group Goals

- Execute TanStack Start CLI with appropriate add-ons
- Identify gaps between add-on output and target structure
- Apply integration templates from the payload directory
- Install additional dependencies (iron-session)
- Provide progress feedback throughout the process

## Initialization Order (V1)

```
1. TanStack Start with add-ons  â†’  Base React project with integrations
2. Gap analysis                 â†’  Compare output to target (blocking for template decisions)
3. Payload templates            â†’  App shell, protected routes, integration glue
4. Additional dependencies      â†’  iron-session
5. Post-scaffold config         â†’  .env.example, setup instructions
```

> **Note:** Stripe payment integration is deferred to post-V1.

---

## 1.3.1 CLI Orchestration

### 1.3.1a Execute TanStack Start CLI

**Goal:** Run TanStack Start CLI with all required add-ons to create the base project.

**Primary Command:**

```bash
npm create @tanstack/start@latest <project-name> -- \
  --framework React \
  --package-manager npm \
  --toolchain eslint \
  --tailwind \
  --add-ons shadcn,convex,workos
```

**TanStack Start CLI Flags (Validated):**

| Flag | Value | Purpose |
|------|-------|---------|
| `--framework` | `React` | Framework choice |
| `--package-manager` | `npm\|yarn\|pnpm\|bun` | User preference |
| `--toolchain` | `eslint` | Linting/formatting |
| `--tailwind` | (flag) | Add Tailwind CSS |
| `--add-ons` | `shadcn,convex,workos` | Built-in integrations |
| `--target-dir` | `<path>` | Output directory |
| `--no-git` | (flag) | Skip git init if needed |

**Built-in Add-ons Available:**

shadcn, convex, workos, clerk, neon, sentry, prisma, drizzle, trpc, tanstack-query, storybook, and more.

**Success Criteria:**

- Command executes without errors
- Project directory contains expected TanStack Start structure
- Add-on files are present (shadcn components.json, convex/, WorkOS integration)
- `npm install` completes successfully

**Status:** ðŸ”µ Planned

---

### 1.3.1b Gap Analysis

**Goal:** Compare TanStack Start add-on output against the validated target structure to determine what payload templates are needed.

> **Blocking Dependency:** This task must be completed before finalizing payload templates. Other specs can proceed with assumptions about what add-ons provide.

**Steps:**

1. Run TanStack Start with all add-ons in a clean directory
2. Document the exact file structure produced
3. Compare against the validated target (`tmp/r9teststack`)
4. Identify gaps:
   - Files that add-ons don't create
   - Files that need modification (e.g., adding providers to `__root.tsx`)
   - Configuration differences
5. Update payload directory contents based on findings
6. Document findings in this spec

**Reference Target:** `tmp/r9teststack` contains the validated target output structure.

**Questions to Answer:**

- Does the WorkOS add-on create auth route files?
- Does the WorkOS add-on configure iron-session or another session library?
- Does the shadcn add-on install any components, or just configuration?
- Does the Convex add-on create a schema file?

**Status:** ðŸ”µ Planned (blocking for 1.3.2)

---

## 1.3.2 Payload Directory

**Goal:** Establish the template file structure that r9stack copies to generated projects.

> **Dependency:** Final contents depend on gap analysis (1.3.1b). The structure below is based on validated target patterns and will be refined after gap analysis.

### Directory Structure

```
payload/
â”œâ”€â”€ components/               # App shell components
â”‚   â”œâ”€â”€ AppShell.tsx
â”‚   â”œâ”€â”€ AuthProvider.tsx
â”‚   â”œâ”€â”€ ConvexClientProvider.tsx
â”‚   â”œâ”€â”€ NavGroup.tsx
â”‚   â”œâ”€â”€ NavItem.tsx
â”‚   â”œâ”€â”€ Sidebar.tsx
â”‚   â””â”€â”€ UserMenu.tsx
â”œâ”€â”€ lib/                      # Auth and utility files
â”‚   â”œâ”€â”€ auth.ts               # Shared types (User, SessionData)
â”‚   â”œâ”€â”€ auth-client.ts        # Client-side context and hooks
â”‚   â””â”€â”€ auth-server.ts        # Server-side session management
â”œâ”€â”€ routes/                   # Route files to add/merge
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ route.tsx         # Auth guard + AppShell wrapper
â”‚   â”‚   â”œâ”€â”€ index.tsx         # Authenticated home
â”‚   â”‚   â””â”€â”€ demo/
â”‚   â”‚       â””â”€â”€ convex.messages.tsx  # Demo Convex page
â”‚   â””â”€â”€ auth/
â”‚       â”œâ”€â”€ sign-in.tsx       # Redirect to WorkOS AuthKit
â”‚       â”œâ”€â”€ callback.tsx      # OAuth callback handler
â”‚       â””â”€â”€ sign-out.tsx      # Clear session
â””â”€â”€ config/                   # Configuration templates
    â””â”€â”€ .env.example
```

### Application Strategy

**Copy Strategy (V1):**

- Files are copied as-is to target locations (no variable substitution needed for V1)
- Destination paths mirror payload structure:
  - `payload/components/*` â†’ `src/components/*`
  - `payload/lib/*` â†’ `src/lib/*`
  - `payload/routes/*` â†’ `src/routes/*`
  - `payload/config/.env.example` â†’ `.env.example`

**Merge Strategy:**

For files that need to integrate with add-on output:

| File | Merge Approach |
|------|----------------|
| `__root.tsx` | Add AuthProvider and ConvexClientProvider wrappers around existing content |
| `src/lib/utils.ts` | Keep existing (from shadcn), don't overwrite |

### npm Package Inclusion

The payload directory is included in the published npm package via `package.json`:

```json
{
  "files": [
    "dist",
    "payload"
  ]
}
```

Access payload files at runtime via:

```typescript
import { fileURLToPath } from 'url'
import path from 'path'

const __dirname = path.dirname(fileURLToPath(import.meta.url))
const payloadDir = path.join(__dirname, '..', 'payload')
```

**Status:** ðŸ”µ Planned (structure defined, contents pending gap analysis)

---

## 1.3.3 Integration Templates

**Goal:** Apply payload template files to the generated project.

> **Dependency:** Template contents finalized after gap analysis (1.3.1b).

### Likely Templates Needed (pending gap analysis)

Based on the validated target, these are likely gaps:

| Template | Purpose |
|----------|---------|
| App Shell | AppShell.tsx, Sidebar.tsx, NavGroup.tsx, NavItem.tsx |
| User Menu | UserMenu.tsx with auth-aware dropdown |
| Auth Provider | AuthProvider.tsx, ConvexClientProvider.tsx |
| Auth Lib | auth.ts, auth-client.ts, auth-server.ts |
| Protected Routes | `/app/route.tsx` with auth guard |
| Auth Routes | `/auth/sign-in.tsx`, `/auth/callback.tsx`, `/auth/sign-out.tsx` |
| Demo Pages | Example pages showing Convex usage |

### Template Application Steps

1. Copy files from payload directory to target locations
2. For merge files (`__root.tsx`), read existing content and inject providers
3. Skip files that already exist and don't need modification

**Status:** ðŸ”µ Planned (after gap analysis)

---

## 1.3.4 Additional Dependencies

**Goal:** Install dependencies that add-ons don't include.

### Dependencies to Add

```bash
npm install iron-session
```

iron-session is required for encrypted cookie sessions with WorkOS. The WorkOS add-on may not include this.

**Status:** ðŸ”µ Planned

---

## 1.3.5 Post-Scaffold Configuration

**Goal:** Create configuration files and finalize setup.

### Files to Create/Update

| File | Purpose |
|------|---------|
| `.env.example` | Template for environment variables (from payload) |
| `components.json` | Ensure shadcn config matches target |

### Environment Variables Template

```bash
# Convex (auto-populated by `npx convex dev`)
VITE_CONVEX_URL=

# WorkOS (get from https://dashboard.workos.com)
WORKOS_API_KEY=
WORKOS_CLIENT_ID=
WORKOS_REDIRECT_URI=http://localhost:3000/auth/callback

# Session (generate with: openssl rand -base64 32)
WORKOS_COOKIE_PASSWORD=
```

**Status:** ðŸ”µ Planned

---

## 1.3.6 Progress Feedback

**Goal:** Keep users informed during the scaffolding process.

### UX Requirements

- Show clear step indicators (Step 1/4: Creating project...)
- Stream output from TanStack CLI
- Use spinners for longer operations
- Provide clear success/error states
- Show summary and next steps on completion

### Post-Scaffold Instructions

```
âœ… Project created!

Next steps:

1. Set up WorkOS:
   â†’ Create account: https://workos.com/
   â†’ Create application
   â†’ Set redirect URI: http://localhost:3000/auth/callback
   â†’ Copy credentials to .env.local

2. Set up Convex:
   â†’ Run: npx convex dev
   â†’ Follow prompts to create account/project

3. Generate session secret:
   â†’ Run: openssl rand -base64 32
   â†’ Add to .env.local as WORKOS_COOKIE_PASSWORD

4. Start development:
   â†’ Run: npm run dev
   â†’ Open: http://localhost:3000
```

**Status:** ðŸ”µ Planned
